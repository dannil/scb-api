<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sv"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">scb-java-client</a> &gt; <a href="index.source.html" class="el_package">com.github.dannil.scbjavaclient.client</a> &gt; <span class="el_source">AbstractClient.java</span></div><h1>AbstractClient.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2014 Daniel Nilsson
 * 
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.github.dannil.scbjavaclient.client;

import java.util.ArrayList;
import java.util.List;
import java.util.Locale;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import com.fasterxml.jackson.databind.JsonNode;
import com.github.dannil.scbjavaclient.exception.SCBClientUrlNotFoundException;
import com.github.dannil.scbjavaclient.utility.JsonUtility;
import com.github.dannil.scbjavaclient.utility.Localization;
import com.github.dannil.scbjavaclient.utility.URLUtility;
import com.github.dannil.scbjavaclient.utility.requester.AbstractRequester;
import com.github.dannil.scbjavaclient.utility.requester.POSTRequester;
import com.github.dannil.scbjavaclient.utility.requester.RequestMethod;
import com.github.dannil.scbjavaclient.utility.requester.RequesterFactory;

/**
 * Abstract class which specifies how clients should operate.
 * 
 * @author Daniel Nilsson
 */
public abstract class AbstractClient {

	protected static final String ROOT_URL = &quot;http://api.scb.se/OV0104/v1/doris/&quot;;

<span class="fc" id="L45">	private static final Logger LOGGER = LogManager.getLogger(AbstractClient.class);</span>

	protected Locale locale;

	protected Localization localization;

	/**
	 * Default constructor.
	 */
<span class="fc" id="L54">	protected AbstractClient() {</span>
<span class="fc" id="L55">		this.locale = Locale.getDefault();</span>

		// validateLocale();

<span class="fc" id="L59">		this.localization = new Localization(this.locale);</span>
<span class="fc" id="L60">	}</span>

	/**
	 * Overloaded constructor.
	 * 
	 * @param locale
	 *            the locale for this client
	 */
	protected AbstractClient(Locale locale) {
<span class="fc" id="L69">		this();</span>
<span class="fc" id="L70">		this.locale = locale;</span>

		// validateLocale();

<span class="fc" id="L74">		this.localization.setLocale(this.locale);</span>
<span class="fc" id="L75">	}</span>

	/**
	 * Retrieves the language for this client instance.
	 * 
	 * @return the language for this client instance
	 */
	public Locale getLocale() {
<span class="fc" id="L83">		return this.locale;</span>
	}

	/**
	 * Sets the language for this client instance. Note that doing this after a call to
	 * {@link #setLocalizationLanguage(Locale)} overwrites the localization language with the input
	 * of this method.
	 * 
	 * @param locale
	 *            the language for this client
	 */
	public void setLocale(Locale locale) {
<span class="fc" id="L95">		this.locale = locale;</span>

		// validateLocale();

<span class="fc" id="L99">		this.localization.setLocale(locale);</span>
<span class="fc" id="L100">	}</span>

	/**
	 * Changes the language used for the localization. Useful if the client needs to be in a
	 * different language than the error messages.
	 * 
	 * @param locale
	 *            the language for the localization
	 */
	public void setLocalizationLanguage(Locale locale) {
<span class="fc" id="L110">		this.localization.setLocale(locale);</span>
<span class="fc" id="L111">	}</span>

	/**
	 * Determines the base URL for the API based on the current locale.
	 * 
	 * @return the URL representing the entry point for the API.
	 */
	protected String getBaseUrl() {
<span class="fc" id="L119">		return ROOT_URL + this.locale.getLanguage() + &quot;/ssd/&quot;;</span>
	}

	/**
	 * Performs a GET request to the specified URL.
	 * 
	 * @param url
	 *            the URL which will be sent a GET request
	 * @return a string representation of the API's response
	 */
	protected String get(String url) {
<span class="fc" id="L130">		AbstractRequester get = RequesterFactory.getRequester(RequestMethod.GET);</span>
		try {
<span class="fc" id="L132">			return get.getBodyAsString(getBaseUrl() + url);</span>
<span class="fc" id="L133">		} catch (SCBClientUrlNotFoundException e) {</span>
			// 404, call the client again with the fallback language
<span class="fc" id="L135">			return get.getBodyAsString(URLUtility.changeLanguageForUrl(getBaseUrl() + url));</span>
		}
	}

	/**
	 * Performs a POST request to the specified URL.
	 * 
	 * @param url
	 *            the URL which will be sent a POST request
	 * @param query
	 *            the query which the API will process
	 * @return a string representation of the API's response
	 */
	protected String post(String url, String query) {
<span class="fc" id="L149">		POSTRequester post = (POSTRequester) RequesterFactory.getRequester(RequestMethod.POST);</span>
<span class="fc" id="L150">		post.setQuery(query);</span>
		try {
<span class="fc" id="L152">			LOGGER.info(query);</span>
<span class="fc" id="L153">			String response = post.getBodyAsString(getBaseUrl() + url);</span>
<span class="fc" id="L154">			return response;</span>
<span class="fc" id="L155">		} catch (SCBClientUrlNotFoundException e) {</span>
			// 404, call the client again with the fallback language
<span class="fc" id="L157">			return post.getBodyAsString(URLUtility.changeLanguageForUrl(getBaseUrl() + url));</span>
		}
	}

	/**
	 * Returns the list of the available regions for a given URL.
	 * 
	 * @param url
	 *            the URL to retrieve the regions from
	 * @return a list of the available regions for the given URL
	 * @throws UnsupportedOperationException
	 *             if the specified URL doesn't supply a regions table
	 */
	public List&lt;String&gt; getRegions(String url) {
<span class="fc" id="L171">		String content = get(url);</span>

<span class="fc" id="L173">		JsonNode contentAsJsonNode = JsonUtility.toNode(content);</span>

<span class="fc" id="L175">		List&lt;String&gt; codes = contentAsJsonNode.findValuesAsText(&quot;code&quot;);</span>
<span class="fc" id="L176">		List&lt;JsonNode&gt; values = contentAsJsonNode.findValues(&quot;values&quot;);</span>

<span class="fc" id="L178">		int position = codes.indexOf(&quot;Region&quot;);</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">		if (position &lt; 0) {</span>
<span class="fc" id="L180">			Object[] variables = new Object[] { url };</span>

<span class="fc" id="L182">			throw new UnsupportedOperationException(this.localization.getString(&quot;regions_is_not_supported_for_url&quot;,</span>
<span class="fc" id="L183">					variables));</span>
		}

<span class="fc" id="L186">		JsonNode jsonRegions = values.get(position);</span>

<span class="fc" id="L188">		List&lt;String&gt; regions = new ArrayList&lt;String&gt;(jsonRegions.size());</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">		for (int j = 0; j &lt; jsonRegions.size(); j++) {</span>
<span class="fc" id="L190">			regions.add(jsonRegions.get(j).asText());</span>
		}

<span class="fc" id="L193">		return regions;</span>
	}

	/**
	 * Returns the list of the available years for a given URL.
	 * 
	 * @param url
	 *            the URL to retrieve the years from
	 * @return a list of the available years for the given URL
	 * @throws UnsupportedOperationException
	 *             if the specified URL doesn't supply a years table
	 */
	public List&lt;String&gt; getYears(String url) {
<span class="fc" id="L206">		String content = get(url);</span>

<span class="fc" id="L208">		JsonNode contentAsJsonNode = JsonUtility.toNode(content);</span>

<span class="fc" id="L210">		List&lt;String&gt; codes = contentAsJsonNode.findValuesAsText(&quot;code&quot;);</span>
<span class="fc" id="L211">		List&lt;JsonNode&gt; values = contentAsJsonNode.findValues(&quot;values&quot;);</span>

<span class="fc" id="L213">		int position = codes.indexOf(&quot;Tid&quot;);</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">		if (position &lt; 0) {</span>
<span class="fc" id="L215">			Object[] variables = new Object[] { url };</span>

<span class="fc" id="L217">			throw new UnsupportedOperationException(this.localization.getString(&quot;years_is_not_supported_for_url&quot;,</span>
<span class="fc" id="L218">					variables));</span>
		}

<span class="fc" id="L221">		JsonNode jsonYears = values.get(position);</span>

<span class="fc" id="L223">		List&lt;String&gt; years = new ArrayList&lt;String&gt;(jsonYears.size());</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">		for (int j = 0; j &lt; jsonYears.size(); j++) {</span>
<span class="fc" id="L225">			years.add(jsonYears.get(j).asText());</span>
		}

<span class="fc" id="L228">		return years;</span>
	}

	// private void validateLocale() {
	// if (!isSupportedLocale(this.locale)) {
	// throw new SCBClientException(&quot;Locale &quot; + this.locale + &quot; is not supported by the API&quot;);
	// }
	// }

	/**
	 * Returns the URL endpoint which this client represents.
	 *
	 * @return the URL endpoint for this client
	 */
	public String getUrl() {
<span class="fc" id="L243">		return getBaseUrl();</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>